#!/usr/bin/env ruby

require 'optparse'
require 'rubygems'
require 'beaver'

# This application was installed by RubyGems as part of the 'beaver' gem.

def parse_date(date)
  case date
    when /^[0-9]{4}-[0-9]{2}-[0-9]{2}$/ then Date.parse(date)
    when /^-\d+$/ then Date.today + date.to_i
    else nil
  end
end

options = {}
o = OptionParser.new do |opts|
  opts.banner = 'Usage: beaver dams.rb [options] /path/to/rails/production.log [/another/log [/yet/another/log]]'
  opts.on('--on DATE', 'Only include log entries from the given date (yyyy-mm-dd or -n days)') { |d| options[:on] = parse_date(d) }
  opts.on('--after DATE', 'Only include log entries from after the given date (yyyy-mm-dd or -n days)') { |d| options[:after] = parse_date(d) }
  opts.on('--before DATE', 'Only include log entries from before the given date (yyyy-mm-dd or -n days)') { |d| options[:before] = parse_date(d) }
  opts.on('--today', 'Alias to --on=-0') { options[:on] = Date.today }
  opts.on('--yesterday', 'Alias to --on=-1') { options[:on] = Date.today-1 }
end
o.parse!

if ARGV.size < 2
  puts o.banner
  exit 1
end

beaver_file = File.open(ARGV.shift, &:read)
Beaver.parse *[ARGV, options].flatten do
  eval beaver_file
end
